import pyPapillonNDL as pndl
import matplotlib.pyplot as plt
import numpy as np
from ir_lambda import generate_U238_U235_ir_lambda
import sys
import h5py

# SHEM-281
mg_energy_bounds =  np.array([1.964030E+07, 1.491823E+07, 1.384029E+07, 1.161833E+07,
              9.999987E+06, 9.048363E+06, 8.187297E+06, 7.408173E+06,
              6.703192E+06, 6.065299E+06, 4.965847E+06, 4.065691E+06,
              3.328707E+06, 2.725314E+06, 2.231299E+06, 1.901387E+06,
              1.636539E+06, 1.405768E+06, 1.336941E+06, 1.286961E+06,
              1.162048E+06, 1.051149E+06, 9.511189E+05, 8.600058E+05,
              7.065112E+05, 5.784425E+05, 4.940018E+05, 4.560211E+05,
              4.125012E+05, 3.838835E+05, 3.206464E+05, 2.678264E+05,
              2.300137E+05, 1.950077E+05, 1.649989E+05, 1.399995E+05,
              1.227732E+05, 1.156235E+05, 9.466450E+04, 8.229736E+04,
              6.737938E+04, 5.516557E+04, 4.991587E+04, 4.086766E+04,
              3.697859E+04, 3.345961E+04, 2.928101E+04, 2.739441E+04,
              2.610010E+04, 2.499908E+04, 2.269941E+04, 1.858471E+04,
              1.620045E+04, 1.489967E+04, 1.360366E+04, 1.113774E+04,
              9.118808E+03, 7.465848E+03, 6.112520E+03, 5.004508E+03,
              4.097345E+03, 3.481068E+03, 2.996183E+03, 2.578838E+03,
              2.219627E+03, 1.910451E+03, 1.614038E+03, 1.345061E+03,
              1.135007E+03, 1.064962E+03, 9.075007E+02, 7.485173E+02,
              6.128342E+02, 5.017462E+02, 4.107950E+02, 3.535746E+02,
              3.199275E+02, 2.837502E+02, 2.417960E+02, 1.979658E+02,
              1.620807E+02, 1.327005E+02, 1.086459E+02, 8.895177E+01,
              7.504548E+01, 6.144204E+01, 5.267255E+01, 4.579131E+01,
              4.399581E+01, 4.016895E+01, 3.372011E+01, 2.760769E+01,
              2.460856E+01, 2.253556E+01, 2.237836E+01, 2.215569E+01,
              2.200114E+01, 2.170178E+01, 2.148585E+01, 2.133597E+01,
              2.122956E+01, 2.114481E+01, 2.106040E+01, 2.097632E+01,
              2.076761E+01, 2.068470E+01, 2.060213E+01, 2.051988E+01,
              2.041754E+01, 2.027512E+01, 2.007338E+01, 1.959735E+01,
              1.939265E+01, 1.919969E+01, 1.908484E+01, 1.795905E+01,
              1.775903E+01, 1.756476E+01, 1.744572E+01, 1.683053E+01,
              1.655014E+01, 1.604977E+01, 1.577923E+01, 1.486626E+01,
              1.473012E+01, 1.459522E+01, 1.447024E+01, 1.425053E+01,
              1.404961E+01, 1.354604E+01, 1.332970E+01, 1.259997E+01,
              1.247210E+01, 1.230855E+01, 1.213015E+01, 1.197947E+01,
              1.181529E+01, 1.170943E+01, 1.158944E+01, 1.126944E+01,
              1.105292E+01, 1.080376E+01, 1.057925E+01, 9.500024E+00,
              9.140311E+00, 8.979950E+00, 8.800375E+00, 8.673690E+00,
              8.524074E+00, 8.300322E+00, 8.130272E+00, 7.970079E+00,
              7.839651E+00, 7.739943E+00, 7.600350E+00, 7.380153E+00,
              7.139869E+00, 6.994292E+00, 6.917776E+00, 6.870208E+00,
              6.835259E+00, 6.810696E+00, 6.791653E+00, 6.776050E+00,
              6.759807E+00, 6.742254E+00, 6.716683E+00, 6.631257E+00,
              6.606106E+00, 6.588293E+00, 6.571843E+00, 6.556090E+00,
              6.539066E+00, 6.514916E+00, 6.481775E+00, 6.432057E+00,
              6.359784E+00, 6.280153E+00, 6.160108E+00, 6.059906E+00,
              5.960142E+00, 5.800211E+00, 5.720146E+00, 5.619790E+00,
              5.530036E+00, 5.488167E+00, 5.410245E+00, 5.380032E+00,
              5.320112E+00, 5.210076E+00, 5.109974E+00, 4.933232E+00,
              4.767845E+00, 4.419800E+00, 4.309812E+00, 4.219828E+00,
              4.000000E+00, 3.882170E+00, 3.712087E+00, 3.543073E+00,
              3.142109E+00, 2.884047E+00, 2.775121E+00, 2.740922E+00,
              2.719898E+00, 2.700115E+00, 2.640041E+00, 2.620053E+00,
              2.590094E+00, 2.550003E+00, 2.469941E+00, 2.330061E+00,
              2.272986E+00, 2.217087E+00, 2.156948E+00, 2.070095E+00,
              1.989920E+00, 1.900077E+00, 1.779966E+00, 1.668949E+00,
              1.588030E+00, 1.519976E+00, 1.443967E+00, 1.410007E+00,
              1.380981E+00, 1.330952E+00, 1.293038E+00, 1.250939E+00,
              1.213968E+00, 1.169989E+00, 1.147969E+00, 1.129974E+00,
              1.116049E+00, 1.103950E+00, 1.091982E+00, 1.077986E+00,
              1.034993E+00, 1.021012E+00, 1.009035E+00, 9.965005E-01,
              9.819591E-01, 9.639598E-01, 9.440222E-01, 9.199779E-01,
              8.800244E-01, 8.200371E-01, 7.199989E-01, 6.249987E-01,
              5.949930E-01, 5.549897E-01, 5.200108E-01, 4.750165E-01,
              4.315786E-01, 3.900011E-01, 3.529935E-01, 3.250079E-01,
              3.050115E-01, 2.799888E-01, 2.549965E-01, 2.311923E-01,
              2.096102E-01, 1.900049E-01, 1.618953E-01, 1.379994E-01,
              1.199949E-01, 1.042977E-01, 8.979683E-02, 7.649686E-02,
              6.519936E-02, 5.549815E-02, 4.730186E-02, 4.029993E-02,
              3.439976E-02, 2.929889E-02, 2.493942E-02, 2.001035E-02,
              1.482996E-02, 1.045050E-02, 7.145263E-03, 4.556021E-03,
              2.499897E-03, 1.100027E-04])

def main():
  if len(sys.argv) != 2:
    raise RuntimeError("Script takes 1 argument: File with MG data library.")
  
  mg_lib = h5py.File(sys.argv[1], 'r+')

  ace = pndl.ACE("/mnt/c/Users/BELANH2/Documents/nuclear_data/ENDF-VIII.0/abeille/data/neutron_dir/U/U238/U238.600.0.ace")
  U238 = pndl.STNeutron(ace)
  
  ace = pndl.ACE("/mnt/c/Users/BELANH2/Documents/nuclear_data/ENDF-VIII.0/abeille/data/neutron_dir/U/U235/U235.600.0.ace")
  U235 = pndl.STNeutron(ace)

  for NucName in mg_lib.keys():
    NucGrp = mg_lib[NucName]
    awr = NucGrp.attrs['awr']
    if awr <= 1.:
      continue
    print(">>> Processing {:}".format(NucName))
    sig_pot = NucGrp.attrs['potential-xs']
    ir_lmbda = generate_U238_U235_ir_lambda(U238, U235, awr=awr, sig_pot=sig_pot, mg_energy_bounds=mg_energy_bounds)
    NucGrp.attrs['ir-lambda'] = ir_lmbda

  mg_lib.close() 

if __name__ == "__main__":
  main()
